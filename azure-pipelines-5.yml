trigger:
- master

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: '7e0f26b8-7f0c-4622-80f8-783dfa9d2f96'
  containerRegistry: 'votingapp.azurecr.io'

  # Microservices Information
  service1Name: 'result'
  service1Dockerfile: 'result/Dockerfile'
  service1Deployment: 'result'
  service1Container: 'result'

  service2Name: 'vote'
  service2Dockerfile: 'vote/Dockerfile'
  service2Deployment: 'vote'
  service2Container: 'vote'

  service3Name: 'worker'
  service3Dockerfile: 'worker/Dockerfile'
  service3Deployment: 'k8s-manifest-files/worker/*'
  service3Container: 'worker'

  tag: '$(Build.BuildId)'

  aksCluster: 'aks-azure-pipeline'
  aksResourceGroup: 'demo-app'

pool:
  name: 'azurepool'

stages:

# ---------------------- BUILD & PUSH ----------------------
- stage: Build
  displayName: Build & Push to ACR
  jobs:
  - job: BuildAndPush
    displayName: Build and Push All Microservices
    steps:

    - task: Docker@2
      displayName: Build & Push ResultApp
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(service1Name)'
        command: 'buildAndPush'
        Dockerfile: '$(service1Dockerfile)'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push VoteApp
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(service2Name)'
        command: 'buildAndPush'
        Dockerfile: '$(service2Dockerfile)'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push Auth Service
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(service3Name)'
        command: 'buildAndPush'
        Dockerfile: '$(service3Dockerfile)'
        tags: '$(tag)'

# ---------------------- DEPLOY TO AKS ----------------------
- stage: Deploy
  displayName: Deploy All to AKS
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: Deploy All Microservices to AKS
    steps:
    - task: Bash@3
      displayName: Install Azure CLI if not present
      inputs:
        targetType: inline
        script: |
          if ! command -v az &> /dev/null
          then
            echo "Azure CLI not found. Installing..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          else
            echo "Azure CLI already installed."
          fi

    - task: Bash@3
      displayName: Install kubectl
      inputs:
        targetType: inline
        script: |
          echo "ðŸ“¦ Installing kubectl..."
          sudo az aks install-cli
          kubectl version --client
    - task: AzureCLI@2
      displayName: Login to AKS and Deploy
      inputs:
        azureSubscription: azure-pipeline-connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ðŸ”¹ Connecting to AKS..."
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksCluster) --overwrite-existing

          echo "ðŸ“Œ Applying Kubernetes manifests..."
          kubectl apply -f k8s-manifest-files/result/*
          kubectl apply -f k8s-manifest-files/worker/*
          kubectl apply -f k8s-manifest-files/vote/*

          echo "ðŸš€ Deploying ResultApp..."
          kubectl set image deployment/$(service1Deployment) $(service1Container)=$(containerRegistry)/$(service1Name):$(tag)
          kubectl rollout status deployment/$(service1Deployment)

          echo "ðŸš€ Deploying VoteApp..."
          kubectl set image deployment/$(service2Deployment) $(service2Container)=$(containerRegistry)/$(service2Name):$(tag)
          kubectl rollout status deployment/$(service2Deployment)

          echo "ðŸš€ Deploying Auth Service..."
          kubectl set image deployment/$(service3Deployment) $(service3Container)=$(containerRegistry)/$(service3Name):$(tag)
          kubectl rollout status deployment/$(service3Deployment)

          echo "âœ… All microservices successfully deployed!"
