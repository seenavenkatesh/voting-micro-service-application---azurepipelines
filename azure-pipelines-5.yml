trigger:
- master



variables:
  acrServiceConnection: '7e0f26b8-7f0c-4622-80f8-783dfa9d2f96'     # Docker Registry service connection
  azureRMConnection: 'azure-service'           # Azure Resource Manager service connection

  acrName: 'votingapp.azurecr.io'
  tag: '$(Build.BuildId)'

  # Microservice folders
  resultPath: 'result'
  votePath: 'vote'
  workerPath: 'worker'

  aksCluster: 'aks-azure-pipeline'
  aksResourceGroup: 'demo-app'
pool:
  name: 'azurepool'
stages:

# ------------------------------------------------------
# BUILD & PUSH IMAGES
# ------------------------------------------------------
- stage: Build
  jobs:
  - job: BuildAndPush
    displayName: Build & Push all microservices to ACR
    steps:
    - task: Docker@2
      displayName: Build & Push Result Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'result'
        command: buildAndPush
        Dockerfile: '$(resultPath)/Dockerfile'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push Vote Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'vote'
        command: buildAndPush
        Dockerfile: '$(votePath)/Dockerfile'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push Worker Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'worker'
        command: buildAndPush
        Dockerfile: '$(workerPath)/Dockerfile'
        tags: '$(tag)'


# ------------------------------------------------------
# DEPLOY TO AKS
# ------------------------------------------------------
- stage: Deploy
  dependsOn: Build
  jobs:
  - job: DeployToAKS
    displayName: Deploy All Services to AKS
    steps:
    - task: AzureCLI@2
      displayName: Deploy to AKS
      inputs:
        azureSubscription: '$(azureRMConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üîπ Connecting to AKS"
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksCluster) --overwrite-existing

          echo "üìå Applying manifests"
          kubectl apply -f k8s-manifests/result
          kubectl apply -f k8s-manifests/vote
          kubectl apply -f k8s-manifests/worker

          echo "üöÄ Updating deployments with new image"
          kubectl set image deployment/result result=$(acrName)/result:$(tag)
          kubectl set image deployment/vote vote=$(acrName)/vote:$(tag)
          kubectl set image deployment/worker worker=$(acrName)/worker:$(tag)

          echo "‚è≥ Waiting for rollout"
          kubectl rollout status deployment/result
          kubectl rollout status deployment/vote
          kubectl rollout status deployment/worker

          echo "‚úÖ Deployment Completed Successfully!"
