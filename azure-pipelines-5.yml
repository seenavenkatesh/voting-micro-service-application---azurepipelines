trigger:
- master

variables:
  acrServiceConnection: '7e0f26b8-7f0c-4622-80f8-783dfa9d2f96'     # Docker Registry Service Connection
  azureRMConnection: 'azure-service'                               # Azure Resource Manager Service Connection

  acrName: 'votingapp.azurecr.io'
  tag: '$(Build.BuildId)'

  resultPath: 'result'
  votePath: 'vote'
  workerPath: 'worker'

  aksCluster: 'aks-azure-pipeline'
  aksResourceGroup: 'demo-app'

pool:
  name: 'azurepool'

stages:

# ------------------------------------------------------
# BUILD & PUSH IMAGES
# ------------------------------------------------------
- stage: Build
  jobs:
  - job: BuildAndPush
    displayName: Build & Push all microservices to ACR
    steps:
    - task: Docker@2
      displayName: Build & Push Result Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'result'
        command: buildAndPush
        Dockerfile: '$(resultPath)/Dockerfile'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push Vote Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'vote'
        command: buildAndPush
        Dockerfile: '$(votePath)/Dockerfile'
        tags: '$(tag)'

    - task: Docker@2
      displayName: Build & Push Worker Service
      inputs:
        containerRegistry: '$(acrServiceConnection)'
        repository: 'worker'
        command: buildAndPush
        Dockerfile: '$(workerPath)/Dockerfile'
        tags: '$(tag)'


# ------------------------------------------------------
# DEPLOY TO AKS
# ------------------------------------------------------
- stage: Deploy
  dependsOn: Build
  jobs:
  - job: DeployToAKS
    displayName: Deploy All Services to AKS
    steps:
    # Install kubectl (only if not present)
    - task: Bash@3
      displayName: Install kubectl if missing
      inputs:
        targetType: inline
        script: |
          if ! command -v kubectl &> /dev/null
          then
            echo "kubectl not found. Installing..."
            sudo az aks install-cli
          else
            echo "kubectl already installed."
          fi

    - task: AzureCLI@2
      displayName: Deploy to AKS
      inputs:
        azureSubscription: '$(azureRMConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ðŸ”¹ Connecting to AKS"
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksCluster) --overwrite-existing

          echo "ðŸ“Œ Applying Kubernetes Manifests"
          kubectl apply -f k8s-manifests
